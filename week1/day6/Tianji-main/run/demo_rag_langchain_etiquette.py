# =============================================================================
# Tianjiæ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿ - ä¸“ç”¨ç‰ˆæœ¬
# =============================================================================
# åŠŸèƒ½ï¼šä¸“é—¨é’ˆå¯¹æ•¬é…’ç¤¼ä»ªåœºæ™¯çš„çŸ¥è¯†é—®ç­”ç³»ç»Ÿ
# ç‰¹ç‚¹ï¼š
# - ä¸“æ³¨äºæ•¬é…’ç¤¼ä»ªçŸ¥è¯†åº“
# - ä½¿ç”¨æ™ºè°±AIçš„åµŒå…¥å’Œè¯­è¨€æ¨¡å‹
# - åŸºäºChromaå‘é‡æ•°æ®åº“å®ç°RAG
# - æä¾›Gradioäº¤äº’ç•Œé¢
# =============================================================================

# åŸºç¡€åº“
import os  # æ–‡ä»¶å’Œè·¯å¾„æ“ä½œ
import gradio as gr  # Webç•Œé¢æ¡†æ¶
from dotenv import load_dotenv  # ç¯å¢ƒå˜é‡åŠ è½½

# LangChainç›¸å…³ç»„ä»¶
from tianji.knowledges.langchain_onlinellm.models import ZhipuAIEmbeddings, ZhipuLLM  # æ™ºè°±AIæ¨¡å‹
from langchain_chroma import Chroma  # å‘é‡æ•°æ®åº“
from langchain_community.document_loaders import DirectoryLoader, TextLoader  # æ–‡æ¡£åŠ è½½å™¨
from langchain_text_splitters import RecursiveCharacterTextSplitter  # æ–‡æœ¬åˆ†å‰²å™¨
from langchain_core.runnables import RunnablePassthrough  # é“¾å¼å¤„ç†ç»„ä»¶
from langchain_core.output_parsers import StrOutputParser  # è¾“å‡ºè§£æå™¨
from langchain import hub  # æç¤ºè¯ä¸­å¿ƒ

# é¡¹ç›®ç›¸å…³
from tianji import TIANJI_PATH  # é¡¹ç›®è·¯å¾„å¸¸é‡
from huggingface_hub import snapshot_download  # HuggingFaceæ•°æ®é›†ä¸‹è½½

# åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆå¦‚APIå¯†é’¥ç­‰ï¼‰
load_dotenv()

# =============================================================================
# æ•°æ®é›†ä¸‹è½½å’Œå‡†å¤‡
# =============================================================================
# åŠŸèƒ½ï¼šä»HuggingFaceä¸‹è½½æ•¬é…’ç¤¼ä»ªæ•°æ®é›†
# æ•°æ®é›†ï¼šsanbu/tianji-chinese åŒ…å«å„ç§äººæƒ…ä¸–æ•…åœºæ™¯çš„çŸ¥è¯†
# ä¸‹è½½ä½ç½®ï¼šTIANJI_PATH/temp/tianji-chinese/
# =============================================================================

# æ„å»ºæ•°æ®é›†ä¸‹è½½ç›®æ ‡è·¯å¾„
destination_folder = os.path.join(TIANJI_PATH, "temp", "tianji-chinese")

# ä½¿ç”¨HuggingFaceçš„snapshot_downloadä¸‹è½½å®Œæ•´æ•°æ®é›†
snapshot_download(
    repo_id="sanbu/tianji-chinese",  # æ•°æ®é›†ä»“åº“ID
    local_dir=destination_folder,  # æœ¬åœ°ä¿å­˜è·¯å¾„
    repo_type="dataset",  # ä»“åº“ç±»å‹ä¸ºæ•°æ®é›†
    local_dir_use_symlinks=False,  # ä¸ä½¿ç”¨ç¬¦å·é“¾æ¥ï¼Œç›´æ¥å¤åˆ¶æ–‡ä»¶
)


# =============================================================================
# å‘é‡æ•°æ®åº“åˆ›å»ºå‡½æ•°
# =============================================================================
# åŠŸèƒ½ï¼šåˆ›å»ºå’Œç®¡ç†Chromaå‘é‡æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨æ–‡æ¡£åµŒå…¥
# å‚æ•°ï¼š
# - data_path: æ–‡æ¡£æ•°æ®è·¯å¾„
# - persist_directory: å‘é‡æ•°æ®åº“æŒä¹…åŒ–è·¯å¾„
# - embedding_func: åµŒå…¥å‡½æ•°
# - chunk_size: æ–‡æœ¬åˆ†å‰²å—å¤§å°
# - force: æ˜¯å¦å¼ºåˆ¶é‡æ–°åˆ›å»ºæ•°æ®åº“
# è¿”å›ï¼šChromaå‘é‡æ•°æ®åº“å®ä¾‹
# =============================================================================

def create_vectordb(
    data_path: str,
    persist_directory: str,
    embedding_func,
    chunk_size: int,
    force: bool = False,
):
    """åˆ›å»ºå‘é‡æ•°æ®åº“"""
    
    # å¦‚æœæ•°æ®åº“å·²å­˜åœ¨ä¸”ä¸éœ€è¦å¼ºåˆ¶é‡å»ºï¼Œç›´æ¥åŠ è½½ç°æœ‰æ•°æ®åº“
    if os.path.exists(persist_directory) and not force:
        print(f"åŠ è½½ç°æœ‰å‘é‡æ•°æ®åº“: {persist_directory}")
        return Chroma(
            persist_directory=persist_directory, embedding_function=embedding_func
        )

    # å¦‚æœéœ€è¦å¼ºåˆ¶é‡å»ºï¼Œå…ˆåˆ é™¤ç°æœ‰æ•°æ®åº“
    if force and os.path.exists(persist_directory):
        print(f"å¼ºåˆ¶é‡å»ºå‘é‡æ•°æ®åº“ï¼Œåˆ é™¤: {persist_directory}")
        if os.path.isdir(persist_directory):
            import shutil
            shutil.rmtree(persist_directory)  # åˆ é™¤æ•´ä¸ªç›®å½•
        else:
            os.remove(persist_directory)  # åˆ é™¤å•ä¸ªæ–‡ä»¶

    # åŠ è½½æ–‡æ¡£
    print(f"å¼€å§‹åŠ è½½æ–‡æ¡£: {data_path}")
    loader = DirectoryLoader(data_path, glob="*.txt", loader_cls=TextLoader)
    
    # æ–‡æœ¬åˆ†å‰²è®¾ç½®
    text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=chunk_size,  # æ¯ä¸ªæ–‡æœ¬å—çš„æœ€å¤§é•¿åº¦
        chunk_overlap=200  # æ–‡æœ¬å—ä¹‹é—´çš„é‡å é•¿åº¦ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§
    )
    
    # åˆ†å‰²æ–‡æ¡£
    split_docs = text_splitter.split_documents(loader.load())
    
    # æ£€æŸ¥åˆ†å‰²ç»“æœ
    if len(split_docs) == 0:
        raise gr.Error("å½“å‰çŸ¥è¯†æ•°æ®æ— æ•ˆ,å¤„ç†æ•°æ®åä¸ºç©º")
    
    print(f"æ–‡æ¡£åˆ†å‰²å®Œæˆï¼Œå…±{len(split_docs)}ä¸ªæ–‡æœ¬å—")

    # åˆ›å»ºå‘é‡æ•°æ®åº“
    print(f"åˆ›å»ºå‘é‡æ•°æ®åº“: {persist_directory}")
    vector_db = Chroma.from_documents(
        documents=split_docs,  # æ–‡æ¡£åˆ—è¡¨
        embedding=embedding_func,  # åµŒå…¥å‡½æ•°
        persist_directory=persist_directory,  # æŒä¹…åŒ–è·¯å¾„
    )
    
    return vector_db


# =============================================================================
# RAGé“¾åˆå§‹åŒ–å‡½æ•°
# =============================================================================
# åŠŸèƒ½ï¼šåˆ›å»ºå®Œæ•´çš„RAGå¤„ç†é“¾ï¼Œä¸“é—¨é’ˆå¯¹æ•¬é…’ç¤¼ä»ªåœºæ™¯
# å‚æ•°ï¼š
# - chunk_size: æ–‡æœ¬åˆ†å‰²å—å¤§å°
# - persist_directory: å‘é‡æ•°æ®åº“æŒä¹…åŒ–è·¯å¾„
# - data_path: æ–‡æ¡£æ•°æ®è·¯å¾„
# è¿”å›ï¼šå®Œæ•´çš„RAGå¤„ç†é“¾
# è¯´æ˜ï¼š
# - ä½¿ç”¨æ™ºè°±AIçš„åµŒå…¥å’Œè¯­è¨€æ¨¡å‹
# - é’ˆå¯¹æ•¬é…’ç¤¼ä»ªåœºæ™¯ä¼˜åŒ–äº†æç¤ºè¯æ¨¡æ¿
# =============================================================================

def initialize_chain(chunk_size: int, persist_directory: str, data_path: str):
    """åˆå§‹åŒ–æ•¬é…’ç¤¼ä»ªä¸“ç”¨çš„RAGå¤„ç†é“¾"""
    print("å¼€å§‹åˆå§‹åŒ–æ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿ...")
    
    # æ­¥éª¤1: åˆ›å»ºåµŒå…¥æ¨¡å‹
    print("åˆ›å»ºæ™ºè°±AIåµŒå…¥æ¨¡å‹...")
    embeddings = ZhipuAIEmbeddings()
    
    # æ­¥éª¤2: åˆ›å»ºå‘é‡æ•°æ®åº“
    print("åˆ›å»ºæ•¬é…’ç¤¼ä»ªå‘é‡æ•°æ®åº“...")
    vectordb = create_vectordb(data_path, persist_directory, embeddings, chunk_size)
    
    # æ­¥éª¤3: åˆ›å»ºæ£€ç´¢å™¨
    print("åˆ›å»ºæ–‡æ¡£æ£€ç´¢å™¨...")
    retriever = vectordb.as_retriever()
    
    # æ­¥éª¤4: è·å–å¹¶è‡ªå®šä¹‰RAGæç¤ºè¯æ¨¡æ¿
    print("é…ç½®æ•¬é…’ç¤¼ä»ªä¸“ç”¨æç¤ºè¯...")
    prompt = hub.pull("rlm/rag-prompt")  # ä»LangChain Hubè·å–æ ‡å‡†RAGæç¤ºè¯
    
    # è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ¿ï¼Œä¸“é—¨é’ˆå¯¹æ•¬é…’ç¤¼ä»ªåœºæ™¯ä¼˜åŒ–
    prompt.messages[0].prompt.template = """
    æ‚¨æ˜¯ä¸€åç”¨äºé—®ç­”ä»»åŠ¡çš„åŠ©æ‰‹ã€‚ä½¿ç”¨æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡æ¥å›ç­”é—®é¢˜ã€‚å¦‚æœæ‚¨ä¸çŸ¥é“ç­”æ¡ˆï¼Œå°±ç›´æ¥è¯´ä¸çŸ¥é“ã€‚\
    1.æ ¹æ®æˆ‘çš„æé—®,æ€»ç»“æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡ä¸­ä¸æé—®æœ€æ¥è¿‘çš„éƒ¨åˆ†,å°†ç›¸å…³éƒ¨åˆ†æµ“ç¼©ä¸ºä¸€æ®µè¯è¿”å›;
    2.æ ¹æ®è¯­æ–™ç»“åˆæˆ‘çš„é—®é¢˜,ç»™å‡ºå»ºè®®å’Œè§£é‡Šã€‚\
    \né—®é¢˜ï¼š{question} \nä¸Šä¸‹æ–‡ï¼š{context} \nç­”æ¡ˆï¼š
    """
    
    # æ­¥éª¤5: åˆ›å»ºè¯­è¨€æ¨¡å‹
    print("åˆ›å»ºæ™ºè°±AIè¯­è¨€æ¨¡å‹...")
    llm = ZhipuLLM()
    
    print("æ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
    
    # æ­¥éª¤6: æ„å»ºå®Œæ•´çš„RAGå¤„ç†é“¾
    # ä¸é€šç”¨ç‰ˆæœ¬ç›¸åŒï¼Œä½¿ç”¨LangChainçš„ç®¡é“æ“ä½œç¬¦
    return (
        {"context": retriever | format_docs, "question": RunnablePassthrough()}
        | prompt
        | llm
        | StrOutputParser()
    )


# =============================================================================
# æ–‡æ¡£æ ¼å¼åŒ–å‡½æ•°
# =============================================================================
# åŠŸèƒ½ï¼šå°†æ£€ç´¢åˆ°çš„æ–‡æ¡£åˆ—è¡¨æ ¼å¼åŒ–ä¸ºå•ä¸ªå­—ç¬¦ä¸²
# å‚æ•°ï¼š
# - docs: æ–‡æ¡£å¯¹è±¡åˆ—è¡¨
# è¿”å›ï¼šæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼Œæ–‡æ¡£ä¹‹é—´ç”¨åŒæ¢è¡Œç¬¦åˆ†éš”
# è¯´æ˜ï¼šç”¨äºRAGé“¾ä¸­çš„æ–‡æ¡£æ ¼å¼åŒ–å¤„ç†
# =============================================================================

def format_docs(docs):
    """æ ¼å¼åŒ–æ–‡æ¡£å†…å®¹ï¼Œç”¨äºRAGä¸Šä¸‹æ–‡"""
    # ä½¿ç”¨åŒæ¢è¡Œç¬¦è¿æ¥æ‰€æœ‰æ–‡æ¡£å†…å®¹ï¼Œç¡®ä¿æ–‡æ¡£ä¹‹é—´æœ‰æ¸…æ™°åˆ†éš”
    return "\n\n".join(doc.page_content for doc in docs)


# =============================================================================
# é—®é¢˜å¤„ç†å‡½æ•°
# =============================================================================
# åŠŸèƒ½ï¼šå¤„ç†ç”¨æˆ·é—®é¢˜å¹¶ç”Ÿæˆå›ç­”ï¼ŒåŒæ—¶ç»´æŠ¤èŠå¤©å†å²
# å‚æ•°ï¼š
# - chain: RAGå¤„ç†é“¾
# - question: ç”¨æˆ·é—®é¢˜å­—ç¬¦ä¸²
# - chat_history: èŠå¤©å†å²åˆ—è¡¨
# è¿”å›ï¼š
# - ç©ºå­—ç¬¦ä¸²ï¼ˆæ¸…ç©ºè¾“å…¥æ¡†ï¼‰å’Œæ›´æ–°åçš„èŠå¤©å†å²
# - æˆ–é”™è¯¯ä¿¡æ¯å’Œå½“å‰èŠå¤©å†å²
# =============================================================================

def handle_question(chain, question: str, chat_history):
    """å¤„ç†ç”¨æˆ·é—®é¢˜ï¼Œè°ƒç”¨RAGé“¾ç”Ÿæˆå›ç­”"""
    
    # æ£€æŸ¥é—®é¢˜æ˜¯å¦ä¸ºç©º
    if not question:
        return "", chat_history
    
    try:
        # è°ƒç”¨RAGé“¾ç”Ÿæˆå›ç­”
        result = chain.invoke(question)
        
        # å°†é—®é¢˜å’Œå›ç­”æ·»åŠ åˆ°èŠå¤©å†å²
        chat_history.append((question, result))
        
        # è¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆæ¸…ç©ºè¾“å…¥æ¡†ï¼‰å’Œæ›´æ–°åçš„èŠå¤©å†å²
        return "", chat_history
        
    except Exception as e:
        # é”™è¯¯å¤„ç†ï¼šè¿”å›é”™è¯¯ä¿¡æ¯å’Œå½“å‰èŠå¤©å†å²
        error_msg = f"å¤„ç†é—®é¢˜æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"
        return error_msg, chat_history


# =============================================================================
# ç³»ç»Ÿåˆå§‹åŒ–å’Œé…ç½®
# =============================================================================
# åŠŸèƒ½ï¼šé…ç½®æ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿçš„å„é¡¹å‚æ•°å¹¶åˆå§‹åŒ–
# è¯´æ˜ï¼š
# - æŒ‡å®šæ•¬é…’ç¤¼ä»ªä¸“ç”¨çš„æ•°æ®è·¯å¾„
# - è®¾ç½®å‘é‡æ•°æ®åº“å‚æ•°
# - åˆ›å»ºRAGå¤„ç†é“¾
# =============================================================================

# æ­¥éª¤1: éªŒè¯æ•°æ®è·¯å¾„
# æ•¬é…’ç¤¼ä»ªæ•°æ®ä½äºä¸‹è½½æ•°æ®é›†çš„ç‰¹å®šå­ç›®å½•ä¸­
data_path = os.path.join(TIANJI_PATH, "temp", "tianji-chinese", "RAG", "1-etiquette")
if not os.path.exists(data_path):
    raise FileNotFoundError(f"æ•¬é…’ç¤¼ä»ªæ•°æ®è·¯å¾„ä¸å­˜åœ¨: {data_path}")
print(f"æ•¬é…’ç¤¼ä»ªæ•°æ®è·¯å¾„: {data_path}")

# æ­¥éª¤2: è®¾ç½®ç³»ç»Ÿå‚æ•°
chunk_size = 1024  # æ–‡æœ¬åˆ†å‰²å—å¤§å°ï¼Œé€‚åˆæ•¬é…’ç¤¼ä»ªç›¸å…³æ–‡æ¡£
persist_directory = os.path.join(TIANJI_PATH, "temp", "chromadb_1-etiquette")  # å‘é‡æ•°æ®åº“è·¯å¾„

# æ­¥éª¤3: åˆå§‹åŒ–RAGå¤„ç†é“¾
print("å¼€å§‹åˆå§‹åŒ–æ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿ...")
model_chain = initialize_chain(chunk_size, persist_directory, data_path)
print("æ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼")

# =============================================================================
# Gradioç•Œé¢é…ç½®
# =============================================================================
# åŠŸèƒ½ï¼šå®šä¹‰æ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿçš„Webç•Œé¢
# ç‰¹ç‚¹ï¼š
# - ä¸“é—¨é’ˆå¯¹æ•¬é…’ç¤¼ä»ªåœºæ™¯è®¾è®¡
# - æä¾›å¿«é€Ÿç¤ºä¾‹é—®é¢˜
# - æ”¯æŒå®æ—¶èŠå¤©äº¤äº’
# - å…·æœ‰æ¸…æ™°çš„è§†è§‰å¸ƒå±€
# =============================================================================

# ç•Œé¢æ ‡é¢˜å’Œè¯´æ˜
TITLE = """
# Tianji äººæƒ…ä¸–æ•…å¤§æ¨¡å‹ç³»ç»Ÿ-æ•¬é…’ç‰ˆ(åŸºäºçŸ¥è¯†åº“å®ç°) æ¬¢è¿starï¼\n
## ğŸ¤–å¼€æºé¡¹ç›®åœ°å€ï¼šhttps://github.com/SocialAI-tianji/Tianji
## ä½¿ç”¨æ–¹æ³•ï¼šè¾“å…¥æç¤º,æˆ–ç‚¹å‡»Exampleè‡ªåŠ¨å¡«å……
## å¦‚æœè§‰å¾—å›ç­”ä¸æ»¡æ„,å¯ä»¥é‡å¤å¤šæ¬¡è¯¢é—®
### æˆ‘ä»¬çš„æ„¿æ™¯æ˜¯æ„å»ºä¸€ä¸ªä»æ•°æ®æ”¶é›†å¼€å§‹çš„å¤§æ¨¡å‹å…¨æ ˆå‚ç›´é¢†åŸŸå¼€æºå®è·µ.
"""

# =============================================================================
# Gradioç•Œé¢æ„å»º
# =============================================================================
# åŠŸèƒ½ï¼šä½¿ç”¨Gradioæ„å»ºæ•¬é…’ç¤¼ä»ªé—®ç­”ç•Œé¢
# ç»„ä»¶è¯´æ˜ï¼š
# - æ ‡é¢˜åŒºåŸŸï¼šæ˜¾ç¤ºç³»ç»Ÿæ ‡é¢˜å’Œä½¿ç”¨è¯´æ˜
# - çŠ¶æ€æ˜¾ç¤ºï¼šæ˜¾ç¤ºç³»ç»Ÿåˆå§‹åŒ–çŠ¶æ€
# - èŠå¤©æœºå™¨äººï¼šæ˜¾ç¤ºå¯¹è¯å†å²
# - è¾“å…¥æ¡†ï¼šç”¨æˆ·è¾“å…¥é—®é¢˜
# - ç¤ºä¾‹é—®é¢˜ï¼šå¿«é€Ÿç¤ºä¾‹æŒ‰é’®
# - æ“ä½œæŒ‰é’®ï¼šèŠå¤©å’Œæ¸…é™¤å†å²
# =============================================================================

with gr.Blocks() as demo:
    # æ˜¾ç¤ºæ ‡é¢˜å’Œè¯´æ˜
    gr.Markdown(TITLE)

    # åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
    init_status = gr.Textbox(
        label="åˆå§‹åŒ–çŠ¶æ€", 
        value="æ•°æ®åº“å·²åˆå§‹åŒ–", 
        interactive=False,  # åªè¯»æ¨¡å¼
        info="ç³»ç»ŸçŠ¶æ€ä¿¡æ¯"
    )
    
    # èŠå¤©æœºå™¨äººç»„ä»¶
    chatbot = gr.Chatbot(
        height=450,  # èŠå¤©æ¡†é«˜åº¦
        show_copy_button=True,  # æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®
        label="æ•¬é…’ç¤¼ä»ªé—®ç­”",  # ç»„ä»¶æ ‡ç­¾
        placeholder="è¯·è¾“å…¥å…³äºæ•¬é…’ç¤¼ä»ªçš„é—®é¢˜..."
    )
    
    # ç”¨æˆ·è¾“å…¥æ¡†
    msg = gr.Textbox(
        label="è¾“å…¥ä½ çš„ç–‘é—®", 
        placeholder="ä¾‹å¦‚ï¼šå–é…’åº§ä½æ€ä¹ˆæ’ï¼Ÿ",
        lines=2  # å¤šè¡Œè¾“å…¥
    )

    # å¿«é€Ÿç¤ºä¾‹é—®é¢˜
    examples = gr.Examples(
        label="å¿«é€Ÿç¤ºä¾‹ï¼ˆç‚¹å‡»è‡ªåŠ¨å¡«å……ï¼‰",
        examples=[
            "å–é…’åº§ä½æ€ä¹ˆæ’",  # åº§ä½å®‰æ’
            "å–é…’çš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆ",  # å–é…’æµç¨‹
            "æ¨èçš„æ•¬é…’è¯æ€ä¹ˆè¯´",  # æ•¬é…’è¯
            "å®´ä¼šæ€ä¹ˆç‚¹èœ",  # ç‚¹èœæŠ€å·§
            "å–é…’å®¹æ˜“é†‰æ€ä¹ˆåŠ",  # é˜²é†‰æ–¹æ³•
            "å–é…’çš„è§„çŸ©æ˜¯ä»€ä¹ˆ",  # åŸºæœ¬è§„çŸ©
        ],
        inputs=[msg],  # ç‚¹å‡»ç¤ºä¾‹åå¡«å……åˆ°è¾“å…¥æ¡†
    )

    # æ“ä½œæŒ‰é’®åŒºåŸŸ
    with gr.Row():
        chat_button = gr.Button("å¼€å§‹èŠå¤©", variant="primary")  # ä¸»è¦æŒ‰é’®
        clear_button = gr.ClearButton(
            components=[chatbot], 
            value="æ¸…é™¤èŠå¤©è®°å½•",
            variant="secondary"  # æ¬¡è¦æŒ‰é’®
        )

    # å®šä¹‰å¤„ç†å‡½æ•°
    def invoke_chain(question, chat_history):
        """è°ƒç”¨RAGé“¾å¤„ç†ç”¨æˆ·é—®é¢˜"""
        return handle_question(model_chain, question, chat_history)

    # ç»‘å®šäº‹ä»¶å¤„ç†
    chat_button.click(
        invoke_chain,  # å¤„ç†å‡½æ•°
        inputs=[msg, chatbot],  # è¾“å…¥å‚æ•°
        outputs=[msg, chatbot],  # è¾“å‡ºå‚æ•°
    )
    
    # å›è½¦é”®å‘é€æ¶ˆæ¯
    msg.submit(
        invoke_chain,
        inputs=[msg, chatbot],
        outputs=[msg, chatbot],
    )

# =============================================================================
# åº”ç”¨å¯åŠ¨
# =============================================================================
# åŠŸèƒ½ï¼šå¯åŠ¨æ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿçš„Gradio Webåº”ç”¨
# è¯´æ˜ï¼š
# - åªåœ¨ç›´æ¥è¿è¡Œè„šæœ¬æ—¶å¯åŠ¨
# - è‡ªåŠ¨åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ç•Œé¢
# - æä¾›æ•¬é…’ç¤¼ä»ªç›¸å…³çš„æ™ºèƒ½é—®ç­”æœåŠ¡
# =============================================================================

# å¯åŠ¨Gradioåº”ç”¨
if __name__ == "__main__":
    print("æ­£åœ¨å¯åŠ¨æ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿ...")
    demo.launch(
        server_name="0.0.0.0",  # ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
        server_port=7860,  # é»˜è®¤ç«¯å£
        share=False,  # ä¸åˆ›å»ºå…¬å¼€é“¾æ¥
        inbrowser=True,  # è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
        show_api=True,  # æ˜¾ç¤ºAPIæ–‡æ¡£
    )
    print("æ•¬é…’ç¤¼ä»ªRAGç³»ç»Ÿå·²å¯åŠ¨ï¼")
